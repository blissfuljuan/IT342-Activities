<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Contact Form - Google Contacts Manager</title>
</head>
<body>
    <div th:replace="~{main :: body(content=~{::content})}">
        <div th:fragment="content">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h3 th:text="${contactForm.resourceName != null ? 'Edit Contact' : 'Create New Contact'}">
                                Contact Form
                            </h3>
                        </div>
                        <div class="card-body">
                            <form id="contactForm" th:action="${contactForm.resourceName != null ? '/contacts/edit/' + contactForm.resourceName : '/contacts/new'}" 
                                  th:object="${contactForm}" method="post">
                                
                                <!-- Add CSRF token -->
                                <input type="hidden" id="csrfToken" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <input type="hidden" id="csrfHeader" th:value="${_csrf.headerName}" />
                                
                                <!-- Make sure resourceName is included for edit operations -->
                                <input type="hidden" th:if="${contactForm.resourceName != null}" 
                                       th:field="*{resourceName}" id="resourceName" />
                                
                                <div class="mb-3">
                                    <label for="firstName" class="form-label">First Name</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-person"></i></span>
                                        <input type="text" class="form-control" id="firstName" 
                                               th:field="*{firstName}" required>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="lastName" class="form-label">Last Name</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-person"></i></span>
                                        <input type="text" class="form-control" id="lastName" 
                                               th:field="*{lastName}" required>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                                        <input type="email" class="form-control" id="email" 
                                               th:field="*{email}">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="phoneNumber" class="form-label">Phone Number</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                                        <input type="tel" class="form-control" id="phoneNumber" 
                                               th:field="*{phoneNumber}">
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <a th:href="@{/contacts}" class="btn btn-secondary me-md-2">
                                        <i class="bi bi-x-circle me-1"></i>Cancel
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-circle me-1"></i>
                                        <span th:text="${contactForm.resourceName != null ? 'Update' : 'Create'}">Submit</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript to handle form submission for PUT requests -->
    <script th:if="${contactForm.resourceName != null}">
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('contactForm');
            const statusMessageDiv = document.createElement('div');
            statusMessageDiv.className = 'alert mt-3';
            statusMessageDiv.style.display = 'none';
            form.after(statusMessageDiv);
            
            function showMessage(message, isError) {
                statusMessageDiv.textContent = message;
                statusMessageDiv.className = isError ? 'alert alert-danger mt-3' : 'alert alert-success mt-3';
                statusMessageDiv.style.display = 'block';
                
                if (!isError) {
                    setTimeout(() => {
                        window.location.href = '/contacts';
                    }, 1500);
                }
            }
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Show loading message
                showMessage('Updating contact...', false);
                statusMessageDiv.className = 'alert alert-info mt-3';
                
                // Get form data
                const formData = {
                    resourceName: document.getElementById('resourceName').value,
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    phoneNumber: document.getElementById('phoneNumber').value
                };
                
                // Get CSRF token
                const csrfToken = document.getElementById('csrfToken').value;
                const csrfHeader = document.getElementById('csrfHeader').value;
                
                // Extract resourceId from resourceName
                let resourceId = formData.resourceName;
                if (resourceId.startsWith('people/')) {
                    resourceId = resourceId.substring(7);
                }
                
                // Make PUT request to the new API endpoint
                fetch(`/api/contacts/edit/${resourceId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    if (response.ok) {
                        return response.json().then(data => {
                            showMessage('Contact updated successfully! Redirecting to contacts list...', false);
                        });
                    } else {
                        throw new Error(`Failed to update contact (Status: ${response.status})`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('An error occurred while updating the contact: ' + error.message, true);
                });
            });
        });
    </script>
</body>
</html>
